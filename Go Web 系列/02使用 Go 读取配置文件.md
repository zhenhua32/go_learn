<!-- TOC -->

- [ç®€ä»‹](#ç®€ä»‹)
- [ä½¿ç”¨ viper è¯»å–é…ç½®](#ä½¿ç”¨-viper-è¯»å–é…ç½®)
- [ä½¿ç”¨ Cobra åˆ›å»ºå‘½ä»¤è¡Œå·¥å…·](#ä½¿ç”¨-cobra-åˆ›å»ºå‘½ä»¤è¡Œå·¥å…·)
- [çƒ­é‡è½½](#çƒ­é‡è½½)
- [æ€»ç»“](#æ€»ç»“)
- [å½“å‰éƒ¨åˆ†çš„ä»£ç ](#å½“å‰éƒ¨åˆ†çš„ä»£ç )

<!-- /TOC -->

## ç®€ä»‹

åœ¨ä¸Šæ¬¡çš„å®è·µä¸­, å¯åŠ¨äº†ä¸€ä¸ªåŸºç¡€çš„ restful api server.

å½“æ—¶çš„ä»£ç ä¸­æœ‰å¾ˆå¤šç¡¬ç¼–ç çš„å±æ€§, è¿™æ¬¡å°±è¦å°è¯•ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–.

## ä½¿ç”¨ viper è¯»å–é…ç½®

è¿™é‡Œä½¿ç”¨ [viper](https://github.com/spf13/viper) è¯»å–é…ç½®, é¦–å…ˆå®‰è£…ä¸€ä¸‹.

```bash
go get -u github.com/spf13/viper
```

åˆ›å»ºä¸€ä¸ª config ç›®å½•, ç„¶åæ·»åŠ  config.go æ–‡ä»¶, åœ¨é‡Œé¢å®šä¹‰ä¸€ä¸ªç»“æ„ Config, ä½¿ç”¨ Name ä¿å­˜é…ç½®è·¯å¾„.

```go
type Config struct {
	Name string
}
```

ç„¶åå®šä¹‰å®ƒçš„ä¸¤ä¸ªæ–¹æ³•, ä¸€ä¸ªè¯»å–é…ç½®, å¦ä¸€ä¸ªè§‚å¯Ÿé…ç½®çš„æ”¹åŠ¨.

```go
// è¯»å–é…ç½®
func (c *Config) InitConfig() error {
	if c.Name != "" {
		viper.SetConfigFile(c.Name)
	} else {
		viper.AddConfigPath("conf")
		viper.SetConfigName("config")
	}
	viper.SetConfigType("yaml")

	// ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–
	viper.AutomaticEnv()
	viper.SetEnvPrefix("web")
	viper.SetEnvKeyReplacer(strings.NewReplacer("_", "."))

	return viper.ReadInConfig()
}

// ç›‘æ§é…ç½®æ”¹åŠ¨
func (c *Config) WatchConfig(change chan int) {
	viper.WatchConfig()
	viper.OnConfigChange(func(e fsnotify.Event) {
		log.Printf("é…ç½®å·²ç»è¢«æ”¹å˜: %s", e.Name)
		change <- 1
	})
}
```

è¯»å–é…ç½®æ—¶å®šä¹‰äº†å¤šç§æ–¹å¼, ç¬¬ä¸€ä¸ªç§æ˜¯æ²¡æœ‰å®šä¹‰ Config.Name,
c.Name ä¸ºç©ºå­—ç¬¦ä¸²çš„æƒ…å†µ, è¿™æ—¶ä¼šä»é»˜è®¤è·¯å¾„ä¸­å¯»æ‰¾é…ç½®æ–‡ä»¶.

å¦å¤–ä¸€ç§å°±æ˜¯ç›´æ¥æŒ‡å®šäº†é…ç½®æ–‡ä»¶çš„è·¯å¾„, é‚£æ˜¯å°±ç›´æ¥ä½¿ç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶.

å¦å¤–, æ¿€æ´»äº†ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–é…ç½®å‚æ•°, æ³¨æ„è®¾ç½®äº†æ‰€æœ‰ç¯å¢ƒå˜é‡çš„å‰ç¼€,
å‰ç¼€ä¼šè‡ªåŠ¨è½¬æ¢ä¸º `å¤§å†™_` çš„æ ¼å¼.

å¦å¤–, å¯¹äºå¤šå±‚çº§çš„é…ç½®å‚æ•°æ¥è¯´, ä¼šè‡ªåŠ¨å°†ç¯å¢ƒå˜é‡ä¸­çš„ `_` è½¬æ¢ä¸º `.`.

ä¸¾ä¸ªä¾‹å­, å½“å‰è®¾ç½®çš„å‰ç¼€ä¸º `web`. å®šä¹‰ä¸€ä¸ªç¯å¢ƒå˜é‡åä¸º `WEB_LOG_PATH`,
ä¼šè‡ªåŠ¨è½¬æ¢ä¸º `log.path`, å°±å¯ä»¥ä½¿ç”¨ `viper.GetString("log.path")`
æˆ–è€…è¿™ä¸ªç¯å¢ƒå˜é‡å¯¹åº”çš„å€¼äº†.

## ä½¿ç”¨ Cobra åˆ›å»ºå‘½ä»¤è¡Œå·¥å…·

ä½¿ç”¨ viper è¯»å–é…ç½®ä¹‹å, ä¸ºäº†æ›´çµæ´»çš„ä½¿ç”¨, åŠ¿å¿…è¦ä½¿ç”¨ CLI å·¥å…·,
ä»¥ä¾¿åœ¨è¿è¡Œæ—¶å¯ä»¥æŒ‡å®šå‚æ•°ç­‰.

Cobra æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºç°ä»£åŒ–çš„ CLI ç•Œé¢çš„åº“, èƒ½æä¾›ç±»ä¼¼äº git å’Œ go å·¥å…·çš„èƒ½åŠ›.

[Cobra](https://github.com/spf13/cobra#concepts) çš„ä½œè€…å°±æ˜¯åˆ›å»º viper çš„ä½œè€…,
æ‰€ä»¥è¿™äº›åº“éƒ½æ˜¯ä»¥ ğŸ å‘½åçš„, viper æ˜¯è°è›‡, corba æ˜¯çœ¼é•œè›‡.

corba æ“…é•¿äºèšåˆå¤šä¸ªå‘½ä»¤, å®ƒéµå¾ª **å‘½ä»¤**, **å‚æ•°**, **æ ‡å¿—** çš„ç†å¿µ.

éµä»è¿™ç§ç†å¿µçš„æ¨¡å¼æ˜¯ `APPNAME VERB NOUN --ADJECTIVE` æˆ–è€… `APPNAME COMMAND ARG --FLAG`.

å¯¹äºæˆ‘ä»¬çš„ web é¡¹ç›®æ¥è¯´, ç›®å‰åªæœ‰å¯åŠ¨è¿™ä¸ªæ“ä½œ, æ‰€ä»¥æˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªä¸»åŠ¨ä½œ.

åˆ›å»º cmd ç›®å½•, å¹¶åˆ›å»ºä¸€ä¸ªåä¸º root.go çš„æ–‡ä»¶.

```go
var rootCmd = &cobra.Command{
	Use:   "server",
	Short: "server is a simple restful api server",
	Long: `server is a simple restful api server
	use help get more ifo`,
	Run: func(cmd *cobra.Command, args []string) {
		runServer()
	},
}
```

ä¸»è¦æ˜¯ä½¿ç”¨ `&cobra.Command` å®šä¹‰ä¸€ä¸ªå‘½ä»¤.

é‡Œé¢çš„å‚æ•° `Use` å®šä¹‰å‘½ä»¤çš„åå­—, `Short` å’Œ `Long` åˆ†åˆ«æ˜¯çŸ­é•¿æè¿°,
`Run` å®šä¹‰äº†å®é™…è¦è¿è¡Œçš„ä»£ç .

å®šä¹‰å¥½ä¸»å‘½ä»¤ä¹‹å, å¯èƒ½éœ€è¦æ·»åŠ ä¸€äº›æ“ä½œ, è¿™äº›éƒ½æ˜¯å®šä¹‰åœ¨ `init()` å‡½æ•°ä¸­çš„,
åŒæ—¶åœ¨é‡Œé¢è¿è¡Œäº† `cobra.OnInitialize`, è¿™ä¼šåœ¨æ¯ä¸ªå‘½ä»¤çš„æ‰§è¡Œé˜¶æ®µè¢«è¿è¡Œ.

```go
// åˆå§‹åŒ–, è®¾ç½® flag ç­‰
func init() {
	cobra.OnInitialize(initConfig)
	rootCmd.PersistentFlags().StringVar(&cfgFile, "config", "", "config file (default: ./conf/config.yaml)")
}

// åˆå§‹åŒ–é…ç½®
func initConfig() {
	c := config.Config{
		Name: cfgFile,
	}

	if err := c.InitConfig(); err != nil {
		panic(err)
	}
	log.Printf("è½½å…¥é…ç½®æˆåŠŸ")
	c.WatchConfig(configChange)
}
```

æˆ‘åœ¨è¿™é‡Œè®¾ç½®äº†ä¸€ä¸ªåä¸º config çš„ flag, å³é…ç½®æ–‡ä»¶å¯¹åº”çš„è·¯å¾„.

æœ€å, è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªå‡½æ•°, ç”¨æ¥åŒ…è£…ä¸»å‘½ä»¤çš„æ‰§è¡Œ:

```go
// åŒ…è£…äº† rootCmd.Execute()
func Execute() {
	if err := rootCmd.Execute(); err != nil {
		log.Println(err)
		os.Exit(1)
	}
}
```

å¦‚æ­¤ä¸€æ¥, ä¸»æ–‡ä»¶ `main.go` å°±éå¸¸ç®€å•äº†, å› ä¸ºæˆ‘ä»¬å·²ç»æŠŠä¸»è¦çš„æ‰§è¡Œæ“ä½œ,
å°è£…ä¸º `runServer()`, å¹¶å®šä¹‰åœ¨ä¸»å‘½ä»¤ä¹‹ä¸‹äº†.

```go
func main() {
	cmd.Execute()
}
```

## çƒ­é‡è½½

å‰é¢å®šä¹‰äº†ä¸€ä¸ªè§‚å¯Ÿ viper é…ç½®æ”¹å˜çš„å‡½æ•°, æ³¨æ„åˆ°å®ƒæœ‰ä¸ªé€šé“å‚æ•°,
æˆ‘ä½¿ç”¨é€šé“ä½œä¸ºæ¶ˆæ¯ä¼ é€’æœºåˆ¶.

```go
// ç›‘æ§é…ç½®æ”¹åŠ¨
func (c *Config) WatchConfig(change chan int) {
	viper.WatchConfig()
	viper.OnConfigChange(func(e fsnotify.Event) {
		log.Printf("é…ç½®å·²ç»è¢«æ”¹å˜: %s", e.Name)
		change <- 1
	})
}
```

å½“é…ç½®æ–‡ä»¶è¢«æ”¹å˜ä¹‹å, å…¶å®å®ƒæœ¬èº«ä¼šä¼ é€’ä¸€ä¸ªå«åš `fsnotify.Event`,
ä½†æˆ‘æ²¡æœ‰ä»”ç»†ç ”ç©¶, è€Œæ˜¯é‡‡ç”¨äº†é€šé“ä¼ é€’æ¶ˆæ¯.

```go
// å®šä¹‰ rootCmd å‘½ä»¤çš„æ‰§è¡Œ
func runServer() {
	// è®¾ç½®è¿è¡Œæ¨¡å¼
	gin.SetMode(viper.GetString("runmode"))

	// åˆå§‹åŒ–ç©ºçš„æœåŠ¡å™¨
	app := gin.New()
	// ä¿å­˜ä¸­é—´ä»¶
	middlewares := []gin.HandlerFunc{}

	// è·¯ç”±
	router.Load(
		app,
		middlewares...,
	)

	go func() {
		if err := check.PingServer(); err != nil {
			log.Fatal("æœåŠ¡å™¨æ²¡æœ‰å“åº”", err)
		}
		log.Printf("æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨")
	}()

	// æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£
	addr := viper.GetString("addr")
	log.Printf("å¯åŠ¨æœåŠ¡å™¨åœ¨ http address: %s", addr)

	srv := &http.Server{
		Addr:    addr,
		Handler: app,
	}
	// å¯åŠ¨æœåŠ¡
	go func() {
		if err := srv.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			log.Fatalf("listen: %s\n", err)
		}
	}()

	// ç­‰å¾…é…ç½®æ”¹å˜, ç„¶åé‡å¯
	<-configChange
	if err := srv.Shutdown(context.Background()); err != nil {
		log.Fatal("Server Shutdown:", err)
	}
	runServer()
}
```

å‰é¢éƒ½æ˜¯äº›å¸¸è§„çš„è¿è¡Œå¯åŠ¨, åŒ…æ‹¬ä½¿ç”¨ä¸€ä¸ª goroutine æ£€æŸ¥å¯åŠ¨çš„å¥åº·çŠ¶æ€,
ä½¿ç”¨å¦ä¸€ä¸ª goroutine å¯åŠ¨æœåŠ¡å™¨.

æ³¨æ„æœ€åå‡ è¡Œ, æˆ‘ä»¬åœ¨ç­‰å¾…é€šé“é€šçŸ¥é…ç½®æ–‡ä»¶å·²ç»å‘ç”Ÿäº†æ”¹å˜, ç„¶åå¼€å§‹å…ˆå…³é—­æœåŠ¡å™¨,
æœ€åé‡æ–°è¿è¡Œå¯åŠ¨å‡½æ•°.

æ³¨æ„: è¿™é‡Œå¯èƒ½æœ‰ä¸ª _bug_, é‚£å°±æ˜¯ä¿®æ”¹é…ç½®æ–‡ä»¶å, OnConfigChange ä¼šè§¦å‘ä¸¤æ¬¡,
æš‚æ—¶æ²¡æœ‰ä»€ä¹ˆå¥½çš„è§£å†³æ–¹æ³•. æˆ–è€…å¯ä»¥è€ƒè™‘ä¸€ä¸‹ github issues ä¸Šæåˆ°çš„
[é™æµæ¨¡å¼](https://github.com/gohugoio/hugo/blob/master/watcher/batcher.go).

## æ€»ç»“

è¿™ä¸ªè¿‡ç¨‹ä¸»è¦ç ”ç©¶äº†å¦‚ä½•è¯»å–é…ç½®æ–‡ä»¶, åŒæ—¶ä¹Ÿä½¿ç”¨äº†å‘½ä»¤è¡Œç›¸å…³çš„åº“,
ä¾¿äºä»¥åæ‰©å±•æ›´å¤šçš„å‘½ä»¤.

## å½“å‰éƒ¨åˆ†çš„ä»£ç 

ä½œä¸ºç‰ˆæœ¬ [0.2.0](https://github.com/zhenhua32/go_web/tree/v0.2.0)
